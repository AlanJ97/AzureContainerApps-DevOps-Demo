# =============================================================================
# Application CD - Build, Push, and Deploy
# =============================================================================
# Triggers: Push to dev/main when app/** files change
# Purpose: Build Docker image, push to ACR, deploy to Azure Container Apps
# =============================================================================

name: "App CD"

on:
  push:
    branches:
      - dev
      - main
    paths:
      - 'app/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'Dockerfile'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod

# Only one app deployment at a time per environment
concurrency:
  group: app-cd-${{ github.ref_name }}
  cancel-in-progress: false

env:
  IMAGE_NAME: fastapi-demo

permissions:
  contents: read
  id-token: write

jobs:
  # ===========================================================================
  # Setup & Environment Detection
  # ===========================================================================
  setup:
    name: ðŸ”§ Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      image_tag: ${{ steps.meta.outputs.image_tag }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - name: Determine Environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ inputs.environment }}"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            ENV="prod"
          else
            ENV="dev"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
      
      - name: Generate Image Metadata
        id: meta
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "image_tag=${{ github.ref_name }}-$SHORT_SHA" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Build & Push Docker Image
  # ===========================================================================
  build:
    name: ðŸ³ Build & Push
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      image_digest: ${{ steps.push.outputs.digest }}
      # Note: We don't pass full_image_name as output because GitHub Actions
      # blocks outputs containing secrets (ACR_NAME). Instead, we construct
      # the image name in the deploy job using the image_tag from setup.
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      # Login to ACR using Service Principal (no admin credentials needed!)
      # The Service Principal has Contributor role which includes AcrPush
      - name: Login to ACR
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}
      
      - name: Set ACR Info
        id: acr
        run: |
          echo "login_server=${{ secrets.ACR_NAME }}.azurecr.io" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.acr.outputs.login_server }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=${{ needs.setup.outputs.image_tag }}
            type=raw,value=latest,enable=${{ github.ref_name == 'main' }}
      
      - name: Build and Push
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
            VERSION=${{ needs.setup.outputs.image_tag }}
      
      - name: Output Image Info
        id: image
        run: |
          FULL_IMAGE="${{ steps.acr.outputs.login_server }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }}"
          echo "full_image_name=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "## ðŸ³ Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`$FULL_IMAGE\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.push.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Container Security Scan
  # ===========================================================================
  scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    needs: [setup, build]
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: ACR Login
        run: az acr login --name ${{ secrets.ACR_NAME }}
      
      - name: Run Trivy Vulnerability Scan
        uses: aquasecurity/trivy-action@master
        with:
          # Construct image name here (GitHub blocks outputs containing secrets)
          image-ref: ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true
      
      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy
        continue-on-error: true
      
      - name: Trivy Summary
        run: |
          echo "## ðŸ” Container Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Trivy scan completed. Check Security tab for detailed results." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Deploy to Azure Container Apps
  # ===========================================================================
  deploy:
    name: ðŸš€ Deploy to ACA
    runs-on: ubuntu-latest
    needs: [setup, build, scan]
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      app_url: ${{ steps.deploy.outputs.app_url }}
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: Deploy to Container Apps
        id: deploy
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          RG="${{ secrets.RESOURCE_GROUP_NAME }}"
          APP_NAME="${{ secrets.CONTAINER_APP_NAME }}"
          # Construct image name here instead of passing as output (GitHub blocks outputs containing secrets)
          IMAGE="${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }}"
          
          echo "ðŸ“¦ Deploying $IMAGE to $APP_NAME..."
          
          # Update the container app with the new image
          az containerapp update \
            --name $APP_NAME \
            --resource-group $RG \
            --image $IMAGE \
            --set-env-vars \
              "ENVIRONMENT=$ENV" \
              "GIT_COMMIT=${{ github.sha }}" \
              "DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          
          # Get the app URL
          APP_URL=$(az containerapp show \
            --name $APP_NAME \
            --resource-group $RG \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "app_url=https://$APP_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to: https://$APP_URL"
      
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | ${{ needs.build.outputs.full_image_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ steps.deploy.outputs.app_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Post-Deployment Smoke Tests
  # ===========================================================================
  smoke-test:
    name: ðŸ’¨ Post-Deploy Smoke Test
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Wait for Deployment
        run: sleep 30
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: Run Smoke Tests
        id: smoke
        run: |
          # Get the app URL directly from Azure
          APP_URL=$(az containerapp show \
            --name ${{ secrets.CONTAINER_APP_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          APP_URL="https://$APP_URL"
          
          echo "ðŸ”— App URL: $APP_URL"
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          
          MAX_RETRIES=5
          RETRY_DELAY=10
          SMOKE_PASSED=0
          SMOKE_FAILED=0
          
          # Function to test an endpoint
          test_endpoint() {
            local endpoint=$1
            local expected_field=$2
            local description=$3
            
            echo "ðŸ§ª Testing: $description"
            
            for i in $(seq 1 $MAX_RETRIES); do
              HTTP_STATUS=$(curl -s -o response.json -w "%{http_code}" "$APP_URL$endpoint" || echo "000")
              
              if [ "$HTTP_STATUS" == "200" ]; then
                # Validate response structure if expected_field is provided
                if [ -n "$expected_field" ]; then
                  if jq -e ".$expected_field" response.json > /dev/null 2>&1; then
                    echo "  âœ… $description - HTTP 200, response valid"
                    return 0
                  else
                    echo "  âš ï¸ $description - HTTP 200 but missing '$expected_field' field"
                  fi
                else
                  echo "  âœ… $description - HTTP 200"
                  return 0
                fi
              fi
              
              if [ $i -lt $MAX_RETRIES ]; then
                echo "  â³ Attempt $i failed (HTTP $HTTP_STATUS), retrying..."
                sleep $RETRY_DELAY
              fi
            done
            
            echo "  âŒ $description - FAILED (HTTP $HTTP_STATUS)"
            return 1
          }
          
          echo ""
          echo "=========================================="
          echo "ðŸš€ Running Post-Deployment Smoke Tests"
          echo "=========================================="
          echo ""
          
          # Critical smoke tests
          if test_endpoint "/" "message" "Root endpoint"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          if test_endpoint "/health" "status" "Health endpoint"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          if test_endpoint "/health/ready" "status" "Readiness probe"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          if test_endpoint "/health/live" "status" "Liveness probe"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          if test_endpoint "/info" "app_name" "Info endpoint"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          if test_endpoint "/docs" "" "API Documentation"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          echo ""
          echo "=========================================="
          echo "ðŸ“Š Smoke Test Results: $SMOKE_PASSED passed, $SMOKE_FAILED failed"
          echo "=========================================="
          
          echo "passed=$SMOKE_PASSED" >> $GITHUB_OUTPUT
          echo "failed=$SMOKE_FAILED" >> $GITHUB_OUTPUT
          
          if [ $SMOKE_FAILED -gt 0 ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "status=passed" >> $GITHUB_OUTPUT
            exit 0
          fi
      
      - name: Smoke Test Summary
        if: always()
        run: |
          echo "## ðŸ’¨ Post-Deployment Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** ${{ steps.smoke.outputs.app_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.smoke.outputs.status }}" == "passed" ]; then
            echo "âœ… All smoke tests passed (${{ steps.smoke.outputs.passed }} tests)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Smoke tests failed" >> $GITHUB_STEP_SUMMARY
            echo "- Passed: ${{ steps.smoke.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: ${{ steps.smoke.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`/\` | Root welcome endpoint |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/health\` | Main health check |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/health/ready\` | Kubernetes readiness probe |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/health/live\` | Kubernetes liveness probe |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/info\` | Application information |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/docs\` | API documentation |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Notification
  # ===========================================================================
  notify:
    name: ðŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [setup, build, deploy, smoke-test]
    if: always()
    
    steps:
      - name: Create Deployment Summary
        run: |
          echo "## ðŸ“‹ Deployment Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Test | ${{ needs.smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
