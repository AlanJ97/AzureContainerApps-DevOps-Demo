# =============================================================================
# Application CD - Build, Push, and Deploy
# =============================================================================
# Triggers: Push to dev/main when app/** files change
# Purpose: Build Docker image, push to ACR, deploy to Azure Container Apps
# Features:
#   - Manual approval gate for production (GitHub Environments)
#   - Blue-green deployment with traffic labels (prod only)
#   - Automated smoke tests post-deployment
# =============================================================================

name: "App CD"

on:
  push:
    branches:
      - dev
      - main
    paths:
      - 'app/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'Dockerfile'
      - '.github/workflows/app-cd.yaml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod

# Only one app deployment at a time per environment
concurrency:
  group: app-cd-${{ github.ref_name }}
  cancel-in-progress: false

env:
  IMAGE_NAME: fastapi-demo

permissions:
  contents: read
  id-token: write

jobs:
  # ===========================================================================
  # Setup & Environment Detection
  # ===========================================================================
  setup:
    name: ðŸ”§ Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      image_tag: ${{ steps.meta.outputs.image_tag }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - name: Determine Environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ inputs.environment }}"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            ENV="prod"
          else
            ENV="dev"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
      
      - name: Generate Image Metadata
        id: meta
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "image_tag=${{ github.ref_name }}-$SHORT_SHA" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Build & Push Docker Image
  # ===========================================================================
  build:
    name: ðŸ³ Build & Push
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      image_digest: ${{ steps.push.outputs.digest }}
      # Note: We don't pass full_image_name as output because GitHub Actions
      # blocks outputs containing secrets (ACR_NAME). Instead, we construct
      # the image name in the deploy job using the image_tag from setup.
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      # Login to ACR using Service Principal (no admin credentials needed!)
      # The Service Principal has Contributor role which includes AcrPush
      - name: Set ACR Name
        run: |
          if [[ "${{ needs.setup.outputs.environment }}" == "prod" ]]; then
            ACR_NAME="${{ secrets.ACR_NAME_PROD }}"
          else
            ACR_NAME="${{ secrets.ACR_NAME_DEV }}"
          fi
          if [[ -z "$ACR_NAME" ]]; then
            ACR_NAME="${{ secrets.ACR_NAME }}"
          fi
          if [[ -z "$ACR_NAME" ]]; then
            echo "ACR_NAME is not set. Define repo secrets ACR_NAME_DEV/ACR_NAME_PROD or ACR_NAME." >&2
            exit 1
          fi
          echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
          echo "LOGIN_SERVER=${ACR_NAME}.azurecr.io" >> $GITHUB_ENV

      - name: Login to ACR
        run: |
          az acr login --name ${{ env.ACR_NAME }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.LOGIN_SERVER }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=${{ needs.setup.outputs.image_tag }}
            type=raw,value=latest,enable=${{ github.ref_name == 'main' }}
      
      - name: Build and Push
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
            VERSION=${{ needs.setup.outputs.image_tag }}
      
      - name: Output Image Info
        id: image
        run: |
          FULL_IMAGE="${{ env.LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }}"
          echo "full_image_name=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "## ðŸ³ Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`$FULL_IMAGE\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.push.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Container Security Scan
  # ===========================================================================
  scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    needs: [setup, build]
    
    steps:
      - uses: actions/checkout@v5

      - name: Set ACR Name
        run: |
          if [[ "${{ needs.setup.outputs.environment }}" == "prod" ]]; then
            ACR_NAME="${{ secrets.ACR_NAME_PROD }}"
          else
            ACR_NAME="${{ secrets.ACR_NAME_DEV }}"
          fi
          if [[ -z "$ACR_NAME" ]]; then
            ACR_NAME="${{ secrets.ACR_NAME }}"
          fi
          if [[ -z "$ACR_NAME" ]]; then
            echo "ACR_NAME is not set. Define repo secrets ACR_NAME_DEV/ACR_NAME_PROD or ACR_NAME." >&2
            exit 1
          fi
          echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
          echo "LOGIN_SERVER=${ACR_NAME}.azurecr.io" >> $GITHUB_ENV
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: ACR Login
        run: az acr login --name ${{ env.ACR_NAME }}
      
      - name: Run Trivy Vulnerability Scan
        uses: aquasecurity/trivy-action@master
        with:
          # Construct image name here (GitHub blocks outputs containing secrets)
          image-ref: ${{ env.LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true
      
      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy
        continue-on-error: true
      
      - name: Trivy Summary
        run: |
          echo "## ðŸ” Container Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Trivy scan completed. Check Security tab for detailed results." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Deploy to Azure Container Apps
  # ===========================================================================
  # For prod: Uses blue-green deployment with traffic labels
  # For dev: Simple rolling deployment
  # ===========================================================================
  deploy:
    name: ðŸš€ Deploy to ACA
    runs-on: ubuntu-latest
    needs: [setup, build, scan]
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      app_url: ${{ steps.deploy.outputs.app_url }}
      revision_name: ${{ steps.deploy.outputs.revision_name }}
      deployment_label: ${{ steps.deploy.outputs.deployment_label }}
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: Deploy to Container Apps
        id: deploy
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          RG="${{ secrets.RESOURCE_GROUP_NAME }}"
          APP_NAME="${{ secrets.CONTAINER_APP_NAME }}"
          SHORT_SHA="${{ needs.setup.outputs.short_sha }}"
          if [[ "$ENV" == "prod" ]]; then
            ACR_NAME="${{ secrets.ACR_NAME_PROD }}"
          else
            ACR_NAME="${{ secrets.ACR_NAME_DEV }}"
          fi
          if [[ -z "$ACR_NAME" ]]; then
            ACR_NAME="${{ secrets.ACR_NAME }}"
          fi
          if [[ -z "$ACR_NAME" ]]; then
            echo "ACR_NAME is not set. Define repo secrets ACR_NAME_DEV/ACR_NAME_PROD or ACR_NAME." >&2
            exit 1
          fi
          LOGIN_SERVER="${ACR_NAME}.azurecr.io"
          # Construct image name here instead of passing as output (GitHub blocks outputs containing secrets)
          IMAGE="${LOGIN_SERVER}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }}"
          
          echo "ðŸ“¦ Deploying $IMAGE to $APP_NAME ($ENV)..."
          
          if [[ "$ENV" == "prod" ]]; then
            # =================================================================
            # BLUE-GREEN DEPLOYMENT (Production only)
            # =================================================================
            # 1. Deploy new revision with unique suffix (green)
            # 2. Label it as 'green' (0% traffic initially)
            # 3. Test via green-labeled URL
            # 4. After smoke tests pass, swap traffic to green
            # =================================================================
            
            echo "ðŸ”µðŸŸ¢ Blue-Green Deployment: Creating new revision..."
            
            # Get current active revision (blue)
            CURRENT_REVISION=$(az containerapp revision list \
              --name $APP_NAME \
              --resource-group $RG \
              --query "[?properties.trafficWeight > 0].name | [0]" -o tsv 2>/dev/null || echo "")
            
            echo "Current active revision: ${CURRENT_REVISION:-'none'}"
            
            # Create new revision with commit SHA as suffix
            az containerapp update \
              --name $APP_NAME \
              --resource-group $RG \
              --image $IMAGE \
              --revision-suffix $SHORT_SHA \
              --set-env-vars \
                "ENVIRONMENT=$ENV" \
                "GIT_COMMIT=${{ github.sha }}" \
                "DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            
            NEW_REVISION="${APP_NAME}--${SHORT_SHA}"
            echo "New revision created: $NEW_REVISION"
            
            add_label() {
              local label=$1
              local revision=$2
              local retries=5
              local delay=5

              for i in $(seq 1 $retries); do
                echo "ðŸ·ï¸ Labeling revision '$revision' as '$label' (attempt $i/$retries)..."
                az containerapp revision label add \
                  --name $APP_NAME \
                  --resource-group $RG \
                  --label $label \
                  --revision $revision \
                  --yes && return 0

                echo "  âš ï¸ Label add failed, retrying in ${delay}s..."
                sleep $delay
              done

              echo "âŒ Failed to label revision '$revision' as '$label'"
              return 1
            }

            # Label the new revision as 'green'
            add_label green $NEW_REVISION
            
            # If there's an existing revision, label it as 'blue'
            if [[ -n "$CURRENT_REVISION" && "$CURRENT_REVISION" != "$NEW_REVISION" ]]; then
              add_label blue $CURRENT_REVISION
            fi

            # Keep production traffic on blue until smoke tests pass
            if [[ -n "$CURRENT_REVISION" && "$CURRENT_REVISION" != "$NEW_REVISION" ]]; then
              echo "ðŸ”µðŸŸ¢ Keeping traffic on BLUE (green=0%) until smoke tests pass..."
              az containerapp ingress traffic set \
                --name $APP_NAME \
                --resource-group $RG \
                --label-weight blue=100 green=0
            else
              # First deployment / no prior revision: green becomes live by definition
              echo "ðŸ”µðŸŸ¢ No previous revision detected; routing traffic to GREEN (100%)."
              az containerapp ingress traffic set \
                --name $APP_NAME \
                --resource-group $RG \
                --label-weight green=100
            fi
            
            echo "revision_name=$NEW_REVISION" >> $GITHUB_OUTPUT
            echo "deployment_label=green" >> $GITHUB_OUTPUT
            
          else
            # =================================================================
            # SIMPLE DEPLOYMENT (Dev environment)
            # =================================================================
            az containerapp update \
              --name $APP_NAME \
              --resource-group $RG \
              --image $IMAGE \
              --set-env-vars \
                "ENVIRONMENT=$ENV" \
                "GIT_COMMIT=${{ github.sha }}" \
                "DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            
            echo "deployment_label=latest" >> $GITHUB_OUTPUT
          fi
          
          # Get the app URL
          APP_URL=$(az containerapp show \
            --name $APP_NAME \
            --resource-group $RG \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "app_url=https://$APP_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to: https://$APP_URL"
      
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | ${{ needs.build.outputs.full_image_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ steps.deploy.outputs.app_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Revision | ${{ steps.deploy.outputs.revision_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Label | ${{ steps.deploy.outputs.deployment_label }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Post-Deployment Smoke Tests
  # ===========================================================================
  # For prod: Tests the green-labeled revision (not yet receiving traffic)
  # For dev: Tests the main URL directly
  # ===========================================================================
  smoke-test:
    name: ðŸ’¨ Post-Deploy Smoke Test
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    outputs:
      status: ${{ steps.smoke.outputs.status }}
    
    steps:
      - name: Wait for Deployment
        run: sleep 30
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: Run Smoke Tests
        id: smoke
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          APP_NAME="${{ secrets.CONTAINER_APP_NAME }}"
          RG="${{ secrets.RESOURCE_GROUP_NAME }}"
          
          # Get the app URL directly from Azure
          if [[ "$ENV" == "prod" ]]; then
            # For prod, test the green-labeled URL (new revision, not yet live)
            ENV_ID=$(az containerapp show \
              --name $APP_NAME \
              --resource-group $RG \
              --query "properties.environmentId" -o tsv)
            APP_DOMAIN=$(az resource show --ids "$ENV_ID" --query "properties.defaultDomain" -o tsv)
            APP_URL="https://${APP_NAME}---green.${APP_DOMAIN}"
            echo "ðŸ”µðŸŸ¢ Testing GREEN revision at: $APP_URL"
          else
            # For dev, test the main URL
            FQDN=$(az containerapp show \
              --name $APP_NAME \
              --resource-group $RG \
              --query "properties.configuration.ingress.fqdn" -o tsv)
            APP_URL="https://$FQDN"
            echo "ðŸ”— Testing DEV at: $APP_URL"
          fi

          if [[ "$ENV" == "prod" ]]; then
            echo "â³ Waiting for GREEN label to become available..."
            for i in $(seq 1 12); do
              GREEN_LABEL=$(az containerapp ingress traffic show \
                --name $APP_NAME \
                --resource-group $RG \
                --query "[?label=='green'] | length(@)" -o tsv)
              if [[ "$GREEN_LABEL" != "0" && -n "$GREEN_LABEL" ]]; then
                echo "âœ… GREEN label detected."
                break
              fi
              echo "  â³ Label not ready (attempt $i/12), retrying in 5s..."
              sleep 5
            done
          fi
          
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          
          MAX_RETRIES=5
          RETRY_DELAY=10
          SMOKE_PASSED=0
          SMOKE_FAILED=0
          
          # Function to test an endpoint
          test_endpoint() {
            local endpoint=$1
            local expected_field=$2
            local description=$3
            
            echo "ðŸ§ª Testing: $description"
            
            for i in $(seq 1 $MAX_RETRIES); do
              HTTP_STATUS=$(curl -s -o response.json -w "%{http_code}" "$APP_URL$endpoint" || echo "000")
              
              if [ "$HTTP_STATUS" == "200" ]; then
                # Validate response structure if expected_field is provided
                if [ -n "$expected_field" ]; then
                  if jq -e ".$expected_field" response.json > /dev/null 2>&1; then
                    echo "  âœ… $description - HTTP 200, response valid"
                    return 0
                  else
                    echo "  âš ï¸ $description - HTTP 200 but missing '$expected_field' field"
                  fi
                else
                  echo "  âœ… $description - HTTP 200"
                  return 0
                fi
              fi
              
              if [ $i -lt $MAX_RETRIES ]; then
                echo "  â³ Attempt $i failed (HTTP $HTTP_STATUS), retrying..."
                sleep $RETRY_DELAY
              fi
            done
            
            echo "  âŒ $description - FAILED (HTTP $HTTP_STATUS)"
            return 1
          }
          
          echo ""
          echo "=========================================="
          echo "ðŸš€ Running Post-Deployment Smoke Tests"
          echo "=========================================="
          echo ""
          
          # Critical smoke tests
          if test_endpoint "/" "message" "Root endpoint"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          if test_endpoint "/health" "status" "Health endpoint"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          if test_endpoint "/health/ready" "status" "Readiness probe"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          if test_endpoint "/health/live" "status" "Liveness probe"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          if test_endpoint "/info" "app_name" "Info endpoint"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          if test_endpoint "/docs" "" "API Documentation"; then
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
          else
            SMOKE_FAILED=$((SMOKE_FAILED + 1))
          fi
          
          echo ""
          echo "=========================================="
          echo "ðŸ“Š Smoke Test Results: $SMOKE_PASSED passed, $SMOKE_FAILED failed"
          echo "=========================================="
          
          echo "passed=$SMOKE_PASSED" >> $GITHUB_OUTPUT
          echo "failed=$SMOKE_FAILED" >> $GITHUB_OUTPUT
          
          if [ $SMOKE_FAILED -gt 0 ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "status=passed" >> $GITHUB_OUTPUT
            exit 0
          fi
      
      - name: Smoke Test Summary
        if: always()
        run: |
          echo "## ðŸ’¨ Post-Deployment Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** ${{ steps.smoke.outputs.app_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.smoke.outputs.status }}" == "passed" ]; then
            echo "âœ… All smoke tests passed (${{ steps.smoke.outputs.passed }} tests)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Smoke tests failed" >> $GITHUB_STEP_SUMMARY
            echo "- Passed: ${{ steps.smoke.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: ${{ steps.smoke.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`/\` | Root welcome endpoint |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/health\` | Main health check |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/health/ready\` | Kubernetes readiness probe |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/health/live\` | Kubernetes liveness probe |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/info\` | Application information |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/docs\` | API documentation |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Traffic Switch (Blue-Green) - Production Only
  # ===========================================================================
  # After smoke tests pass, switch 100% traffic to the green revision
  # ===========================================================================
  traffic-switch:
    name: ðŸ”€ Switch Traffic to Green
    runs-on: ubuntu-latest
    needs: [setup, deploy, smoke-test]
    if: needs.setup.outputs.environment == 'prod' && needs.smoke-test.outputs.status == 'passed'
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: Switch Traffic to Green
        id: switch
        run: |
          APP_NAME="${{ secrets.CONTAINER_APP_NAME }}"
          RG="${{ secrets.RESOURCE_GROUP_NAME }}"
          
          echo "ðŸ”€ Switching 100% traffic to GREEN revision..."
          
          # Switch all traffic to the green label (fallback if blue label missing)
          if az containerapp ingress traffic set \
              --name $APP_NAME \
              --resource-group $RG \
              --label-weight blue=0 green=100; then
            echo "ðŸ”€ Traffic switched using blue/green labels."
          else
            echo "ðŸ”€ Blue label not found; switching to green-only."
            az containerapp ingress traffic set \
              --name $APP_NAME \
              --resource-group $RG \
              --label-weight green=100
          fi
          
          echo "âœ… Traffic switched to green revision!"
          
          # Get current traffic distribution
          echo ""
          echo "ðŸ“Š Current traffic distribution:"
          az containerapp ingress traffic show \
            --name $APP_NAME \
            --resource-group $RG
      
      - name: Traffic Switch Summary
        run: |
          echo "## ðŸ”€ Blue-Green Traffic Switch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Traffic successfully switched to GREEN revision**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Label | Traffic |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”µ Blue (previous) | 0% |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¢ Green (current) | 100% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To rollback, run: \`az containerapp ingress traffic set --name ${{ secrets.CONTAINER_APP_NAME }} --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} --label-weight blue=100 green=0\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Notification
  # ===========================================================================
  notify:
    name: ðŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [setup, build, deploy, smoke-test, traffic-switch]
    if: always()
    
    steps:
      - name: Create Deployment Summary
        run: |
          echo "## ðŸ“‹ Deployment Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Test | ${{ needs.smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.setup.outputs.environment }}" == "prod" ]]; then
            echo "| Traffic Switch | ${{ needs.traffic-switch.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
