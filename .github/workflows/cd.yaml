# =============================================================================
# CD Workflow - Continuous Deployment Pipeline
# =============================================================================
# Triggers on push to dev and main branches.
# Runs: Terraform Apply â†’ Docker Build â†’ Push to ACR â†’ Deploy to ACA
# =============================================================================

name: CD Pipeline

run-name: "CD: Deploy to ${{ github.ref_name }}"

on:
  push:
    branches:
      - dev
      - main
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'
  # Allow manual trigger with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

# Only one deployment per environment at a time
concurrency:
  group: cd-${{ github.ref_name }}
  cancel-in-progress: false  # Don't cancel deployments in progress

env:
  TERRAFORM_VERSION: '1.7.0'
  # These will be set per environment
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

jobs:
  # ===========================================================================
  # Job 1: Determine Environment
  # ===========================================================================
  setup:
    name: ðŸ”§ Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      tf_working_dir: ${{ steps.set-env.outputs.tf_working_dir }}
    
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ inputs.environment }}"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            ENV="prod"
          else
            ENV="dev"
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "tf_working_dir=terraform/environments/$ENV" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Deploying to: **$ENV**" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 2: Terraform Apply - Infrastructure Deployment
  # ===========================================================================
  terraform:
    name: ðŸ—ï¸ Terraform Apply
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      acr_name: ${{ steps.tf-output.outputs.acr_name }}
      acr_login_server: ${{ steps.tf-output.outputs.acr_login_server }}
      aca_name: ${{ steps.tf-output.outputs.aca_name }}
      resource_group: ${{ steps.tf-output.outputs.resource_group }}
    
    defaults:
      run:
        working-directory: ${{ needs.setup.outputs.tf_working_dir }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Terraform ${{ env.TERRAFORM_VERSION }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false  # Needed for output parsing
      
      - name: Terraform Init
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init
      
      - name: Terraform Plan
        id: plan
        run: |
          echo "ðŸ“‹ Creating Terraform plan..."
          terraform plan -out=tfplan -input=false
      
      - name: Terraform Apply
        run: |
          echo "ðŸš€ Applying Terraform configuration..."
          terraform apply -auto-approve tfplan
      
      - name: Get Terraform Outputs
        id: tf-output
        run: |
          echo "ðŸ“¤ Retrieving Terraform outputs..."
          echo "acr_name=$(terraform output -raw acr_name)" >> $GITHUB_OUTPUT
          echo "acr_login_server=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT
          echo "aca_name=$(terraform output -raw container_app_name)" >> $GITHUB_OUTPUT
          echo "resource_group=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
      
      - name: Terraform Summary
        run: |
          echo "## ðŸ—ï¸ Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ACR | $(terraform output -raw acr_login_server) |" >> $GITHUB_STEP_SUMMARY
          echo "| Container App | $(terraform output -raw container_app_name) |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | $(terraform output -raw resource_group_name) |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 3: Build and Push Docker Image to ACR
  # ===========================================================================
  build-push:
    name: ðŸ³ Build & Push Image
    runs-on: ubuntu-latest
    needs: [setup, terraform]
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      image_digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: Generate Image Metadata
        id: meta
        run: |
          # Generate image tag with commit SHA
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          IMAGE_TAG="${{ needs.setup.outputs.environment }}-${SHORT_SHA}"
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "ðŸ·ï¸ Image Tag: $IMAGE_TAG"
      
      - name: Build and Push to ACR
        id: build
        run: |
          ACR_NAME="${{ needs.terraform.outputs.acr_name }}"
          ACR_SERVER="${{ needs.terraform.outputs.acr_login_server }}"
          IMAGE_TAG="${{ steps.meta.outputs.image_tag }}"
          
          echo "ðŸ³ Building and pushing image to ACR..."
          echo "   Registry: $ACR_SERVER"
          echo "   Image: aca-devops-demo:$IMAGE_TAG"
          
          # Build using ACR Tasks (builds in Azure, no local Docker needed)
          az acr build \
            --registry $ACR_NAME \
            --image aca-devops-demo:$IMAGE_TAG \
            --image aca-devops-demo:latest \
            --file Dockerfile \
            .
          
          # Get the image digest
          DIGEST=$(az acr repository show-manifests \
            --name $ACR_NAME \
            --repository aca-devops-demo \
            --query "[?tags[?contains(@, '$IMAGE_TAG')]].digest | [0]" \
            --output tsv)
          
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "âœ… Image pushed successfully"
          echo "   Digest: $DIGEST"
      
      - name: Build Summary
        run: |
          echo "## ðŸ³ Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | ${{ needs.terraform.outputs.acr_login_server }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | aca-devops-demo |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | ${{ steps.meta.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ steps.meta.outputs.short_sha }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 4: Security Scan - Container Image (Trivy)
  # ===========================================================================
  scan-image:
    name: ðŸ”’ Scan Image (Trivy)
    runs-on: ubuntu-latest
    needs: [setup, terraform, build-push]
    environment: ${{ needs.setup.outputs.environment }}
    continue-on-error: true  # Don't block deployment on scan failures
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: Get ACR Credentials
        id: acr-creds
        run: |
          ACR_NAME="${{ needs.terraform.outputs.acr_name }}"
          
          # Get ACR login credentials
          ACR_USERNAME=$(az acr credential show --name $ACR_NAME --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv)
          
          echo "::add-mask::$ACR_PASSWORD"
          echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
          echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT
      
      - name: Run Trivy Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ needs.terraform.outputs.acr_login_server }}/aca-devops-demo:${{ needs.build-push.outputs.image_tag }}'
          format: 'table'
          exit-code: '0'  # Don't fail on vulnerabilities
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
        env:
          TRIVY_USERNAME: ${{ steps.acr-creds.outputs.username }}
          TRIVY_PASSWORD: ${{ steps.acr-creds.outputs.password }}
      
      - name: Scan Summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Trivy vulnerability scan completed for image." >> $GITHUB_STEP_SUMMARY
          echo "Check workflow logs for detailed results." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 5: Deploy to Azure Container Apps
  # ===========================================================================
  deploy:
    name: ðŸš€ Deploy to ACA
    runs-on: ubuntu-latest
    needs: [setup, terraform, build-push, scan-image]
    if: always() && needs.build-push.result == 'success'
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
      
      - name: Deploy to Container App
        id: deploy
        run: |
          ACR_SERVER="${{ needs.terraform.outputs.acr_login_server }}"
          ACA_NAME="${{ needs.terraform.outputs.aca_name }}"
          RG_NAME="${{ needs.terraform.outputs.resource_group }}"
          IMAGE_TAG="${{ needs.build-push.outputs.image_tag }}"
          
          FULL_IMAGE="$ACR_SERVER/aca-devops-demo:$IMAGE_TAG"
          
          echo "ðŸš€ Deploying to Azure Container Apps..."
          echo "   Container App: $ACA_NAME"
          echo "   Resource Group: $RG_NAME"
          echo "   Image: $FULL_IMAGE"
          
          # Update the container app with new image
          az containerapp update \
            --name $ACA_NAME \
            --resource-group $RG_NAME \
            --image $FULL_IMAGE \
            --output none
          
          # Get the app URL
          APP_URL=$(az containerapp show \
            --name $ACA_NAME \
            --resource-group $RG_NAME \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv)
          
          echo "app_url=https://$APP_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployment complete!"
          echo "   URL: https://$APP_URL"
      
      - name: Health Check
        id: health
        run: |
          APP_URL="${{ steps.deploy.outputs.app_url }}"
          
          echo "ðŸ¥ Running health check..."
          
          # Wait for deployment to stabilize
          sleep 30
          
          # Check health endpoint
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/health" || echo "000")
            
            if [[ "$HTTP_STATUS" == "200" ]]; then
              echo "âœ… Health check passed! Status: $HTTP_STATUS"
              echo "status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "â³ Attempt $i/5 - Status: $HTTP_STATUS, retrying..."
            sleep 10
          done
          
          echo "âš ï¸ Health check did not return 200 after 5 attempts"
          echo "status=unhealthy" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container App | ${{ needs.terraform.outputs.aca_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ needs.build-push.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ steps.deploy.outputs.app_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health | ${{ steps.health.outputs.status || 'unknown' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Application](${{ steps.deploy.outputs.app_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Health Check](${{ steps.deploy.outputs.app_url }}/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [API Info](${{ steps.deploy.outputs.app_url }}/info)" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 6: CD Summary
  # ===========================================================================
  cd-summary:
    name: ðŸ“‹ CD Summary
    runs-on: ubuntu-latest
    needs: [setup, terraform, build-push, scan-image, deploy]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ“‹ CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Terraform Apply | ${{ needs.terraform.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Build & Push | ${{ needs.build-push.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security Scan | ${{ needs.scan-image.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Deploy to ACA | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
