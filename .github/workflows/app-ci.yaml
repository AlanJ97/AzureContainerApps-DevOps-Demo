# =============================================================================
# Application CI - Python Code Quality & Testing
# =============================================================================
# Triggers: PRs when app/**, tests/** files change
# Purpose: Lint, test, and security scan the Python application
# =============================================================================

name: "App CI"

on:
  pull_request:
    branches:
      - dev
      - main
    paths:
      - 'app/**'
      - 'tests/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'Dockerfile'
      - '.github/workflows/app-ci.yaml'
  push:
    branches:
      - dev
    paths:
      - 'app/**'
      - 'tests/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
  workflow_dispatch:

concurrency:
  group: app-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # ===========================================================================
  # Detect Changes
  # ===========================================================================
  changes:
    name: üìã Detect Changes
    runs-on: ubuntu-latest
    outputs:
      app: ${{ steps.filter.outputs.app }}
      tests: ${{ steps.filter.outputs.tests }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v5
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            app:
              - 'app/**'
              - 'requirements*.txt'
              - 'pyproject.toml'
            tests:
              - 'tests/**'
            docker:
              - 'Dockerfile'
              - '.dockerignore'

  # ===========================================================================
  # Python Linting
  # ===========================================================================
  lint:
    name: üîç Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.app == 'true' || needs.changes.outputs.tests == 'true'
    
    steps:
      - uses: actions/checkout@v5
      
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Linters
        run: pip install flake8 black isort
      
      - name: Run flake8
        run: flake8 app/ tests/ --max-line-length=100 --extend-ignore=E501
        continue-on-error: true
      
      - name: Check Black Formatting
        run: black --check --diff app/ tests/
        continue-on-error: true
      
      - name: Check Import Sorting
        run: isort --check-only --diff app/ tests/
        continue-on-error: true

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  security:
    name: üîê Security Scan
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.app == 'true'
    
    steps:
      - uses: actions/checkout@v5
      
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Bandit
        run: pip install bandit[toml]
      
      - name: Run Bandit Security Scan
        run: bandit -r app/ -f json -o bandit-results.json || true
      
      - name: Upload Bandit Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-results.json
      
      - name: Bandit Summary
        run: |
          echo "## üîê Bandit Security Scan" >> $GITHUB_STEP_SUMMARY
          if [ -f bandit-results.json ]; then
            python3 << 'EOF'
          import json
          with open('bandit-results.json') as f:
              data = json.load(f)
          metrics = data.get('metrics', {}).get('_totals', {})
          print(f"| Metric | Count |")
          print(f"|--------|-------|")
          print(f"| High Severity | {metrics.get('SEVERITY.HIGH', 0)} |")
          print(f"| Medium Severity | {metrics.get('SEVERITY.MEDIUM', 0)} |")
          print(f"| Low Severity | {metrics.get('SEVERITY.LOW', 0)} |")
          EOF
          fi >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Unit Tests
  # ===========================================================================
  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.app == 'true' || needs.changes.outputs.tests == 'true'
    
    steps:
      - uses: actions/checkout@v5
      
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx
      
      - name: Run Tests with Coverage
        run: |
          pytest tests/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=test-results.xml \
            -v
      
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml
      
      - name: Test Summary
        if: always()
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.xml ]; then
            COVERAGE=$(python3 -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); print(f\"{float(tree.getroot().get('line-rate', 0)) * 100:.1f}%\")")
            echo "**Coverage:** $COVERAGE" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Dockerfile Lint
  # ===========================================================================
  dockerfile-lint:
    name: üê≥ Dockerfile Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.docker == 'true'
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Lint Dockerfile with Hadolint
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
          format: sarif
          output-file: hadolint-results.sarif
      
      - name: Upload Hadolint Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: hadolint-results.sarif
          category: hadolint
        continue-on-error: true

  # ===========================================================================
  # CI Summary
  # ===========================================================================
  ci-summary:
    name: ‚úÖ CI Summary
    runs-on: ubuntu-latest
    needs: [lint, security, test, dockerfile-lint]
    if: always()
    
    steps:
      - name: Check Job Results
        run: |
          echo "## üìä App CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfile Lint | ${{ needs.dockerfile-lint.result }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Fail on Critical Issues
        if: needs.test.result == 'failure'
        run: |
          echo "‚ùå Critical job failed: Tests"
          exit 1
